name: Compose Parallel Test

on:
  pull_request:
    branches: [ main, dev ]
  push:
    branches: [ dev ]
  workflow_dispatch:

jobs:
  compose-test:
    name: docker-compose parallel bring-up & tests (${{ matrix.suite }})
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        suite: [auth, mailflow]
    env:
      COMPOSE_PROJECT_NAME: locky-${{ github.run_id }}-${{ github.run_attempt }}
      DOCKER_BUILDKIT: 1
      COMPOSE_DOCKER_CLI_BUILD: 1
      SUITE: ${{ matrix.suite }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Docker versions
        run: |
          docker version
          docker compose version

      - name: Run compose parallel CI
        env:
          SUITE: ${{ matrix.suite }}
        run: |
          chmod +x scripts/main.sh
          ./scripts/main.sh ci run ${{ matrix.suite }}

      - name: Upload logs artifact (${{ matrix.suite }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-logs-${{ matrix.suite }}-${{ github.run_id }}-${{ github.run_attempt }}
          path: artifacts

      - name: Upload logs artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-logs-${{ github.run_id }}-${{ github.run_attempt }}
          path: artifacts

      - name: Teardown already handled
        if: always()
        run: echo "Teardown performed in script trap"
